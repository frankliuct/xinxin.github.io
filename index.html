<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>ä¸ƒå¤• Â· ç»™ä½ çš„å°æƒŠå–œ</title>
  <meta name="theme-color" content="#ff6b81" />
  <style>
    :root{
      --pink:#ff6b81;
      --deep:#ff3b5c;
      --bg:#0b1020;
      --soft:#ffe6ea;
      --card:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans SC",sans-serif;
      background: radial-gradient(1200px 800px at 50% 30%, #1a2142 0%, #0b1020 55%, #070b16 100%);
      color:#fff;
      overflow:hidden; /* é¦–å±ä¸æ»šåŠ¨ï¼Œç¡®è®¤åè§£é” */
      -webkit-tap-highlight-color: transparent;
    }
    .hint{position:fixed;top:14px;left:50%;transform:translateX(-50%);font-size:12px;color:#d7dbff;opacity:.8;z-index:5}

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter: blur(4px);display:flex;align-items:center;justify-content:center;z-index:10;visibility:visible;opacity:1;transition:opacity .4s ease,visibility .4s ease}
    .overlay.hide{opacity:0;visibility:hidden}

    .modal{width:min(92vw, 520px);background:linear-gradient(180deg,#ffffff,#fff6f8);border-radius:20px;box-shadow:0 20px 60px rgba(255,59,92,.35);padding:22px 22px 18px;color:#333;position:relative}
    .modal h1{margin:8px 0 6px;font-size:22px;color:#111;letter-spacing:.5px}
    .modal p{margin:6px 0 14px;line-height:1.6;color:#444}

    .btn{appearance:none;border:0;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;padding:12px 18px;border-radius:999px;font-weight:700;letter-spacing:.5px;transition:.2s;user-select:none}
    .btn-primary{background:linear-gradient(135deg,var(--deep),var(--pink));color:white;box-shadow:0 6px 18px rgba(255,59,92,.35)}
    .btn-primary:active{transform:translateY(1px)}

    .btn-ghost{background:transparent;color:#666;border:1px dashed #ccc}

    .modal .row{display:flex;gap:10px;flex-wrap:wrap}

    .credit{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);font-size:12px;color:#9fa8ff;opacity:.7;z-index:3}

    .heart{position:absolute;width:14px;height:14px;background:var(--pink);transform:rotate(45deg);border-radius:2px;box-shadow:0 0 12px rgba(255,107,129,.7)}
    .heart:before,.heart:after{content:"";position:absolute;width:14px;height:14px;background:var(--pink);border-radius:50%}
    .heart:before{left:-7px}
    .heart:after{top:-7px}

    .petal{position:fixed;top:-10vh;left:0;width:12px;height:10px;background:radial-gradient(circle at 30% 30%,#fff,#ffd1da 40%,#ffa8b6 70%);border-radius:10px;opacity:.9;filter:drop-shadow(0 0 6px rgba(255,107,129,.35));animation:fall linear forwards}
    @keyframes fall{to{transform:translate(var(--dx),100vh) rotate(540deg)}}

    canvas{position:fixed;inset:0;z-index:1}

    .title{position:fixed;top:12vh;width:100%;text-align:center;font-size:clamp(24px,6vw,44px);font-weight:900;letter-spacing:2px;color:#fff;text-shadow:0 4px 24px rgba(255,59,92,.45)}
    .subtitle{position:fixed;top:calc(12vh + clamp(24px,6vw,44px) + 36px);width:100%;text-align:center;font-size:clamp(14px,3.5vw,18px);color:#ffe3e8;opacity:.9}

    .replay{position:fixed;bottom:24px;right:20px;z-index:3}
    .audio-btn{position:fixed;bottom:24px;left:20px;z-index:3}
    .video-btn{position:fixed;bottom:24px;left:140px;z-index:3}

    .stage{opacity:0;transition:opacity .8s ease}
    .stage.show{opacity:1}
  </style>
</head>
<body>
  <div class="hint">ğŸ”Š é˜¿é€šåˆ¶ä½œçš„å°~ç½‘ç«™ï¼Œç¥å§å§æ°¸è¿œå¼€æ£®~</div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h1>æ”¶åˆ°ä¸€ä»½<span style="color:var(--deep)">ä¸ƒå¤•ç¤¼ç‰©</span>ï¼Œè¦æ‰“å¼€å—ï¼Ÿ</h1>
      <p>ä¸“å±å°æƒŠå–œï¼Œåªç»™ä½ çœ‹ï¼ˆç‚¹â€œç¡®å®šâ€å³å¯ï¼‰ã€‚</p>
      <div class="row">
        <button type="button" class="btn btn-primary" id="confirm">ç¡®å®š</button>
        <button type="button" class="btn btn-ghost" id="deny" aria-label="æ‹’ç»" title="æ‹’ç»">â€¦è¿˜æ˜¯å…ˆçœ‹çœ‹</button>
      </div>
    </div>
  </div>

  <div class="stage" id="stage" aria-hidden="true">
    <h1 class="title">ä¸ƒå¤•å¿«ä¹ â¤ï¸</h1>
    <div class="subtitle">æ„¿æ‰€æœ‰æ¸©æŸ”éƒ½å¥”å‘ä½ </div>
    <canvas id="fw"></canvas>
    <!-- èƒŒæ™¯éŸ³ä¹ï¼ˆæ”¾åœ¨ stage é‡Œï¼Œç‚¹å‡»â€œç¡®å®šâ€åæ’­æ”¾ï¼‰ -->
    <audio id="bgm" src="QiBackMusic2.mp3" preload="auto" loop></audio>
    <!-- éŸ³ä¹å¼€å…³ & æ‰“å¼€è§†é¢‘æŒ‰é’® -->
    <button type="button" class="btn btn-primary audio-btn" id="toggleAudio">éŸ³ä¹ï¼šå¼€</button>
    <button type="button" class="btn btn-ghost video-btn" id="openVideo">è§‚çœ‹ç¤¼ç‰©è§†é¢‘</button>
    <button type="button" class="btn btn-primary replay" id="replay">å†æ”¾ä¸€æ¬¡çƒŸèŠ±</button>
  </div>
  <!-- è§†é¢‘å¼¹çª—ï¼ˆå¯é€‰ï¼‰ -->
  <div class="overlay hide" id="videoOverlay" style="z-index:11;">
    <div class="modal" style="max-width:min(92vw,720px)">
      <h1 style="margin:8px 0 10px">ä¸ƒå¤•è§†é¢‘</h1>
      <video id="qixiVideo" playsinline webkit-playsinline controls preload="metadata" src="QiBackVideo.mp4" style="width:100%;border-radius:12px"></video>
      <div class="row" style="margin-top:12px">
        <button type="button" class="btn btn-primary" id="closeVideo">å…³é—­</button>
      </div>
    </div>
  </div>

  <div class="credit">Â© ç»™ä½ çš„å°æœ‹å‹</div>

  <script>
    document.addEventListener("DOMContentLoaded", function(){
    const overlay = document.getElementById('overlay');
    const stage = document.getElementById('stage');
    const confirmBtn = document.getElementById('confirm');
    const denyBtn = document.getElementById('deny');
    const replayBtn = document.getElementById('replay');
    const bgm = document.getElementById('bgm');
    const toggleAudio = document.getElementById('toggleAudio');
    const openVideo = document.getElementById('openVideo');
    const closeVideo = document.getElementById('closeVideo');
    const videoOverlay = document.getElementById('videoOverlay');
    const qixiVideo = document.getElementById('qixiVideo');
    let audioOn = true;
    if(bgm) bgm.volume = 0.7;

    // èƒŒæ™¯éŸ³ä¹æ’­æ”¾ï¼ˆåœ¨ç¡®è®¤åå°è¯•æ’­æ”¾ï¼‰
    confirmBtn.addEventListener('click', async ()=>{
      if(!bgm) return;
      try{ await bgm.play(); }
      catch(e){
        const tip = document.querySelector('.hint');
        if(tip) tip.textContent = 'è½»è§¦å±å¹•ä»»æ„ä½ç½®ä»¥å¼€å§‹éŸ³ä¹~';
        const tapOnce = ()=>{ bgm.play().catch(()=>{}); document.removeEventListener('touchstart', tapOnce); document.removeEventListener('click', tapOnce); };
        document.addEventListener('touchstart', tapOnce, {once:true});
        document.addEventListener('click', tapOnce, {once:true});
      }
    });

    // éŸ³ä¹å¼€/å…³
    if(toggleAudio){
      toggleAudio.addEventListener('click', ()=>{
        if(!bgm) return;
        if(audioOn){ bgm.pause(); toggleAudio.textContent='éŸ³ä¹ï¼šå…³'; audioOn=false; }
        else{ bgm.play().catch(()=>{}); toggleAudio.textContent='éŸ³ä¹ï¼šå¼€'; audioOn=true; }
      });
    }

    // æ‰“å¼€/å…³é—­è§†é¢‘
    if(openVideo && videoOverlay && qixiVideo){
      openVideo.addEventListener('click', ()=>{ videoOverlay.classList.remove('hide'); qixiVideo.currentTime=0; qixiVideo.play().catch(()=>{}); });
    }
    if(closeVideo && videoOverlay && qixiVideo){
      closeVideo.addEventListener('click', ()=>{ qixiVideo.pause(); videoOverlay.classList.add('hide'); });
    }

    confirmBtn.addEventListener('click', () => {
      overlay.classList.add('hide');
      stage.classList.add('show');
      stage.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'auto';
      launchShow();
      startPetals(20);
    });

    let hop = 0;
    denyBtn.addEventListener('mouseenter', () => {
      hop++;
      const dx = 8 + (hop%5)*4;
      denyBtn.style.transform = `translateX(${dx}px)`;
    });

    function burstHearts(x,y,count=10){
      for(let i=0;i<count;i++){
        const h = document.createElement('div');
        h.className='heart';
        document.body.appendChild(h);
        const ang = Math.random()*Math.PI*2;
        const dist = 30+Math.random()*60;
        const tx = x + Math.cos(ang)*dist;
        const ty = y + Math.sin(ang)*dist;
        h.style.left = (x-7) + 'px';
        h.style.top  = (y-7) + 'px';
        h.animate([
          {transform:`translate(0,0) rotate(45deg)`, opacity:1},
          {transform:`translate(${tx-x}px, ${ty-y}px) rotate(45deg)`, opacity:0}
        ], {duration:1200+Math.random()*600, easing:'cubic-bezier(.22,.61,.36,1)'}).onfinish=()=>h.remove();
      }
    }

    function startPetals(n=16){
      for(let i=0;i<n;i++) addPetal();
    }
    function addPetal(){
      const p = document.createElement('div');
      p.className='petal';
      const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
      const delay = Math.random()*2;
      const dur = 10 + Math.random()*10;
      const startX = Math.random()*vw;
      const dx = (Math.random()*vw) - startX;
      p.style.left = startX+'px';
      p.style.setProperty('--dx', dx+'px');
      p.style.animationDuration = dur+'s';
      p.style.animationDelay = delay+'s';
      document.body.appendChild(p);
      p.addEventListener('animationend',()=>{p.remove(); addPetal();});
    }

    const canvas = document.getElementById('fw');
    const ctx = canvas.getContext('2d');
    let W,H,raf,ticks=0, fireworks=[];
    function resize(){ W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    class Particle{
      constructor(x,y,angle,speed,life,color){
        this.x=x; this.y=y; this.vx=Math.cos(angle)*speed; this.vy=Math.sin(angle)*speed; this.life=life; this.al=1; this.color=color; this.g=0.04;
      }
      step(){
        this.x+=this.vx; this.y+=this.vy; this.vy+=this.g; this.life--; this.al = Math.max(0,this.life/60);
        ctx.globalAlpha=this.al; ctx.fillStyle=this.color; ctx.fillRect(this.x,this.y,2,2);
        return this.life>0;
      }
    }

    function fire(x,y){
      const colors=['#ff6b81','#ffd166','#7dd3fc','#a78bfa','#fb7185','#fca5a5'];
      const count = 90+Math.random()*70;
      const col = colors[Math.floor(Math.random()*colors.length)];
      for(let i=0;i<count;i++){
        const a = (Math.PI*2)*Math.random();
        const s = 2 + Math.random()*4.5;
        const l = 40 + Math.random()*40;
        fireworks.push(new Particle(x,y,a,s,l,col));
      }
    }

    function step(){
      raf = requestAnimationFrame(step);
      ctx.globalCompositeOperation='destination-out';
      ctx.fillStyle='rgba(0,0,0,0.25)';
      ctx.fillRect(0,0,W,H);
      ctx.globalCompositeOperation='lighter';
      fireworks = fireworks.filter(p=>p.step());
      ticks++;
      if(ticks%35===0) fire(Math.random()*W, H* (0.25 + Math.random()*0.45));
    }

    function launchShow(){
      cancelAnimationFrame(raf); fireworks=[]; ticks=0; step();
      setTimeout(()=>fire(W*0.5,H*0.35), 400);
      setTimeout(()=>fire(W*0.3,H*0.4), 800);
      setTimeout(()=>fire(W*0.7,H*0.42), 1200);
    }

    canvas.addEventListener('click', (e)=>{
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left; const y = e.clientY - rect.top;
      fire(x,y); burstHearts(e.clientX, e.clientY, 12);
    });

    replayBtn.addEventListener('click', ()=>{
      launchShow();
      burstHearts(window.innerWidth-40, window.innerHeight-40, 12);
    });

    document.addEventListener('click',(e)=>{
      if(stage.classList.contains('show')) return;
      burstHearts(e.clientX, e.clientY, 6);
    }, {capture:true});
      });
  </script>
</body>
</html>
